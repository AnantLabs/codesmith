<%-- 
Name: Quick Start
Author: Reggie Bradshaw
Description: Used to Quick Start Visual Studio Projects
--%>
<%@ CodeTemplate Language="C#" TargetLanguage="Text" Src="" Inherits="" Debug="False" Description="Template description here." CompilerVersion="v3.5" %>
<%@ Assembly Name="System" %>
<%@ Assembly Name="ICSharpCode.SharpZipLib" Path="Common" %>
<%@ Assembly Name="QuickStartUtils" Path="Common"%>
<%@ Assembly Name="SchemaExplorer" %>
<%@ Import Namespace="ICSharpCode.SharpZipLib.Zip" %>
<%@ Import Namespace="System.IO" %>
<%@ Import Namespace="QuickStartUtils" %>
<%@ Register Name="QuickStartSolution" Template="QuickStartSolution.cst" %>
<%@ Property Name="VisualStudioVersion" Type="QuickStartSolution.VisualStudioVersionEnum" Optional="False" Category="1.Project" Description="Version of Visual Studio to Generate for." %>
<%@ Property Name="Location" Type="System.String" Default="" Optional="False" Category="1.Project" Description="This is the path to the project location." %>
<%@ Property Name="CodeSmithSamplesLocation" Type="System.String" Default="" Optional="True" Category="" Description="" %>
<%@ Property Name="ProjectName" Type="System.String" Default="" Optional="False" Category="1.Project" Description="Name of the project to be generated." %>
<%@ Property Name="Language" Type="QuickStartUtils.LanguageEnum" Default="CSharp" Optional="False" Category="1.Project" Description="Language the project will be in" %>
<%@ Property Name="ProjectType" Type="QuickStartUtils.ProjectTypeEnum" Default="DynamicData" Optional="False" Category="" Description="Type of Project to be created" %>
<%@ Property Name="DataContext" Type="System.String" Default="" Optional="False" Category="2.Data" Description="Name Space for the Data Project." %>
<%@ Property Name="IncludePlinqoFiles" Type="System.Boolean" Default="False" Optional="False" Category="2.Data" Description="Include a copy of the LinqToSql Templates in the project directory" %>
<%@ Property Name="SourceDatabase" Type="SchemaExplorer.DatabaseSchema" Default="" Optional="False" Category="3.Database" Description="Source Database" %>

<% CreateDirectoryStructure(); %>
<script runat="template">

	public void CreateDirectoryStructure()
    {   
		// Prep Directories
		if(!Directory.Exists(Location))
			Directory.CreateDirectory(Location);
				
		// Create SolutionItems
		List<QuickStartSolution.SolutionItem> solutionItems = new List<QuickStartSolution.SolutionItem>();
		
		// Create Website Project
		solutionItems.Add(CreateWebsiteProject());
		
		// Create Data Project
		solutionItems.Add(CreateDataProject());
		
		// Copy Plinqo Templates
		if(IncludePlinqoFiles)
            QuickStartUtils.CopyDirectory(@"..\LinqToSql",Location + @"\LinqToSql",0);
		
		// Create Solution
		CreateSolution(solutionItems);
    }
	
	private void CreateSolution(List<QuickStartSolution.SolutionItem> solutionItems)
	{
		QuickStartSolution quickStartSolution = this.Create<QuickStartSolution>();
		quickStartSolution.VisualStudioVersion = VisualStudioVersion;
		quickStartSolution.SolutionItems = solutionItems;
		
		string filePathAboslute = Path.Combine(Location, String.Concat(ProjectName, ".sln"));
		quickStartSolution.RenderToFile(filePathAboslute, true);
	}
	
	#region General File Methods
	
	private void GetVsProject(string directoryPath, string projectFileName)
	{
		string zipFilePath = String.Format("{0}.{1}.zip", FileName, LanguageAppendage);
		string zipProjFileName = String.Format("{0}.{1}proj", FileName, LanguageAppendage);
		UnzipFile(zipFilePath, directoryPath, zipProjFileName, projectFileName);
	}
	private void UnzipFile(string zipFileName, string targetDirectory, params string[] renameFiles)
	{
		// Unzip Files
        FastZip fz = new FastZip();
		string zipFilePath = Path.Combine(ZipFileFolder, zipFileName);
        fz.ExtractZip(zipFilePath, targetDirectory, "");
		
		// Delete the vstempllate file b/c we will not be using it
		string vstemplate = QuickStartUtils.FindFileInDirectory(".vstemplate", targetDirectory);
        File.Delete(vstemplate);
		
		// Rename Files
		if(renameFiles.Length % 2 != 0)
			throw new Exception("UnzipFile() needs an even number of params: SourceFile, DestinationFile");
		for(int x=0; x<renameFiles.Length; x+=2)
		{
			string sourFile = Path.Combine(targetDirectory, renameFiles[x]);
			string destFile = Path.Combine(targetDirectory, renameFiles[x+1]);
			File.Move(sourFile, destFile);
		}
	}
	
	private void VariableUpdateDirectory(string directoryPath, string projectGuid, string projectName)
	{
		QuickStartUtils.ReplaceAllInDirectory(directoryPath, @"\$safeprojectname\$", projectName);
        QuickStartUtils.ReplaceAllInDirectory(directoryPath, @"\$guid1\$", @"{" + projectGuid + @"}");
        QuickStartUtils.ReplaceAllInDirectory(directoryPath, @"\$if\$ \(\$targetframeworkversion\$ == 3.5\)", " ");
        QuickStartUtils.ReplaceAllInDirectory(directoryPath, @"\$endif\$", " ");
        QuickStartUtils.FindAndReplace(Path.Combine(directoryPath, "web.config"), @"<connectionStrings/>",
            @"<connectionStrings>
	            <add name=""" + SourceDatabase.Name + @"ConnectionString"" connectionString=""" + SourceDatabase.ConnectionString + @""" providerName=""System.Data.SqlClient""/>
              </connectionStrings>");
	}
	
	#endregion

	#region CreateWebsiteProject
	
	private QuickStartSolution.SolutionItem CreateWebsiteProject()
	{
		// Prep
		string projectName = String.Concat(ProjectName, ".Website");
		PathHelper pathHelper = new PathHelper(String.Format("{0}.{1}proj", projectName, LanguageAppendage), projectName, Location);
		
		// Create TargetDirectory
		if(!Directory.Exists(pathHelper.DirectoryPath))
			Directory.CreateDirectory(pathHelper.DirectoryPath);
		
		// Create SolutionItem
		QuickStartSolution.SolutionItem solutionItem = new QuickStartSolution.SolutionItem(ProjectName, pathHelper.DirectoryFile, Language);
		
		// Get Files
		CreateWebsiteProject_GetFiles(pathHelper.DirectoryPath, pathHelper.FileName);
		
		// Replace Variables In Files
		CreateWebsiteProject_ReplaceVariables(pathHelper.DirectoryPath, solutionItem.GuidString, projectName);

		// Return Solution Item
		return solutionItem;
	}
	
	private void CreateWebsiteProject_GetFiles(string directoryPath, string projectFileName)
	{
		GetVsProject(directoryPath, projectFileName);
	}
	private void CreateWebsiteProject_ReplaceVariables(string directoryPath, string projectGuid, string projectName)
	{
		VariableUpdateDirectory(directoryPath, projectGuid, projectName);
	}
	
	#endregion
	
	#region CreateDataProject
	
	private QuickStartSolution.SolutionItem CreateDataProject()
	{
		// Prep
		string projectName = String.Concat(ProjectName, ".Data");
		PathHelper pathHelper = new PathHelper(String.Format("{0}.{1}proj", projectName, LanguageAppendage), projectName, Location);
		
		// Create TargetDirectory
		if(!Directory.Exists(pathHelper.DirectoryPath))
			Directory.CreateDirectory(pathHelper.DirectoryPath);
			
		// Create SolutionItem
		QuickStartSolution.SolutionItem solutionItem = new QuickStartSolution.SolutionItem(projectName, pathHelper.DirectoryFile, Language);
		
		// Get Files
		CreateDataProject_GetFiles(pathHelper.DirectoryPath, pathHelper.FileName);
		
		// Replace Variables In Files
		CreateDataProject_ReplaceVariables(pathHelper.DirectoryPath, solutionItem.GuidString, projectName);
		
		// Return Solution Item
		return solutionItem;
	}
	
	private void CreateDataProject_GetFiles(string directoryPath, string projectFileName)
	{
		GetVsProject(directoryPath, projectFileName);
		
		File.Copy(@".\Common\QuickStart.csp", Path.Combine(directoryPath, "QuickStart.csp"));
	}
	private void CreateDataProject_ReplaceVariables(string directoryPath, string projectGuid, string projectName)
	{
		VariableUpdateDirectory(directoryPath, projectGuid, projectName);
		VariableUpdateQuickStartCsp(directoryPath, projectName);
	}
	
	private void VariableUpdateQuickStartCsp(string directoryPath, string projectName)
	{
		string linqToSqlPath = (this.IncludePlinqoFiles) ? @"..\LinqToSql" : String.Empty; //Needs Normal Path here
		string quickStartPath = Path.Combine(directoryPath, "QuickStart.csp");

		QuickStartUtils.FindAndReplace(quickStartPath, @"\$connectionString\$",SourceDatabase.ConnectionString);
    	QuickStartUtils.FindAndReplace(quickStartPath, @"\$myDatabase\$", SourceDatabase.Database.Name);
        QuickStartUtils.FindAndReplace(quickStartPath, @"\$myContextNamespace\$", DataContext);
		QuickStartUtils.FindAndReplace(quickStartPath, @"\$language\$", LanguageFolder);
		QuickStartUtils.FindAndReplace(quickStartPath, @"\$linqToSql\$", linqToSqlPath);
		
		//The location in the csproj file directly below where we want to insert the csp include
        string projectInsertLocation = @"<Import Project=""\$\(MSBuildBinPath\)\\Microsoft\." + LanguageFolder + @"\.targets"" />";
		string reinsertString = @"<Import Project=""$(MSBuildBinPath)\Microsoft." + LanguageFolder + @".targets"" />";
        QuickStartUtils.FindAndReplace(directoryPath + @"\" + projectName + @"." + LanguageAppendage + @"proj", projectInsertLocation,
                @"<ItemGroup>
                    <Generate Include=""QuickStart.csp"" />
                </ItemGroup>
                " + reinsertString);

        QuickStartUtils.FindAndReplace(directoryPath + @"\" + projectName + @"." + LanguageAppendage + @"proj", @"</Project>",
            @"	<Import Project=""$(MSBuildExtensionsPath)\CodeSmith\CodeSmith.targets"" />
				</Project>");
	}
	
	#endregion
	
	#region Properties
	
	//Folder in vs web projects where the correct zip file is located
	protected string LanguageFolder
	{
		get { return (this.Language == QuickStartUtils.LanguageEnum.CSharp)	? "CSharp" : "VisualBasic"; }
	}
	//Some file names in the VS zip files hava an appendage that should be removed
	protected string LanguageAppendage 
	{
		get { return (this.Language == QuickStartUtils.LanguageEnum.CSharp) ? "cs" : "vb"; }
	}
	//A different zip file exists for each project type
	protected string FileName
	{
		get
		{
			string projectTypeFileName;
			switch (ProjectType)
			{
				default:
				case QuickStartUtils.ProjectTypeEnum.DynamicData:
					projectTypeFileName = "DynamicDataLinqToSqlWebApplication";
					break;
				case QuickStartUtils.ProjectTypeEnum.MVC:
					projectTypeFileName = "MvcWebApplicationProjectTemplateP5";
					break;
			}
			return projectTypeFileName;
		}
	}
	protected string ZipFileFolder
	{
		get { return Path.Combine("Common", LanguageFolder); }
	}
	
	#endregion
	
	#region PathHelper Class
	
	public class PathHelper
	{
		public PathHelper(string fileName, string directoryName, string parentPath)
		{
			FileName = fileName;
			DirectoryName = directoryName;
			
			DirectoryFile = Path.Combine(DirectoryName, FileName);
			
			DirectoryPath = Path.Combine(parentPath, DirectoryName);
			FilePath = Path.Combine(DirectoryPath, FileName);
		}
		
		public string FileName { get; private set; }
		public string DirectoryName { get; private set; }
		
		public string DirectoryFile { get; private set; }
		
		public string DirectoryPath { get; private set; }
		public string FilePath { get; private set; }
	}
	
	#endregion
	
</script>
