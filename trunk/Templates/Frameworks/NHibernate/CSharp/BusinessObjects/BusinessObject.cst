<%-- 
Name: BusinessObject.cst
Author: Tom DuPont
Description: Generates a Business Object for NHibernate.
--%>
<%@ CodeTemplate Language="C#" Src="..\Helpers\NHibernateHelper.cs" Inherits="NHibernateHelper" TargetLanguage="C#" Debug="False" Description="Generates a Business Object for NHibernate." %>
<%@ Property Name="SourceTable" Type="SchemaExplorer.TableSchema" Optional="False" Category="1a. Source Table" Description="The source table to generate from." %>
<%@ Property Name="ExcludedTables" Type="SchemaExplorer.TableSchemaCollection" Optional="True" Category="1b. Database Options" Description="A collection of tables to be excluded during generation." %>
<%@ Property Name="TablePrefix" Type="System.String" Default="" Optional="True" Category="1b. Database Options" Description="A prefix that will be stripped from table names when class names are generated." %>
<%@ Property Name="VsVersion" Type="VisualStudioVersion" Default="VS_2008" Optional="False" Category="2. Versions" Description="The version of Visual Studio to generate for." %>
<%@ Property Name="BusinessNamespace" Type="System.String" Default="NHibernate.Generated.BusinessObjects" Optional="False" Category="2. Namespaces" Description="The desired Namespace for the Business Objects." %>
<%@ Property Name="BaseNamespace" Type="System.String" Default="NHibernate.Generated.Base" Optional="False" Category="2. Namespaces" Description="The Namespace where the Base classes (BusinessBase & ManagerBase) are located." %>
<%@ Assembly Name="SchemaExplorer" %>
<%@ Assembly Name="System.Data" %>
<%@ Import Namespace="SchemaExplorer" %>
<%@ Import Namespace="System.Data" %>
<%@ Map Name="SystemCSharp" Src="System-CSharpAlias" %>
<% this.tablePrefix = TablePrefix; %>
using System;
using System.Collections;
using System.Collections.Generic;

using <%= BaseNamespace %>;

namespace <%= BusinessNamespace %>
{
    public partial class <%= GetClassName(SourceTable.Name) %> : BusinessBase<<%= SystemCSharp[GetBusinessBaseIdType(SourceTable).ToString()] %>>
    {
        #region Declarations

		<% // Primary Keys %>
		<% if(IsMutliColumnPrimaryKey(SourceTable.PrimaryKey)) { %>
		<% foreach(MemberColumnSchema mcs in SourceTable.PrimaryKey.MemberColumns) { %>
		private <%= SystemCSharp[mcs.SystemType.ToString()] %> <%= GetPrivateVariableName(mcs.Name) %> = <%= GetInitialization(mcs.SystemType) %>;
		<% } %>
		<% } %>
		
		<% // Primitives %>
		<% foreach(ColumnSchema column in SourceTable.NonKeyColumns) { %>
		private <%= SystemCSharp[column.SystemType.ToString()] %> <%= GetPrivateVariableName(column.Name) %> = <%= GetInitialization(column.SystemType) %>;
		<% } %>
		
		<% // Many-To-One %>
		<% foreach(TableKeySchema tks in SourceTable.ForeignKeys) { %>
		<% foreach(MemberColumnSchema mcs in tks.ForeignKeyMemberColumns) { %>
		<% if(!ExcludedTables.Contains(tks.PrimaryKeyTable) && !mcs.IsPrimaryKeyMember) { %>
		private <%= GetClassName(tks.PrimaryKeyTable.Name) %> <%= GetPrivateVariableName(GetClassName(tks.PrimaryKeyTable.Name)) %> = null;
		<% } %>
		<% } %>
		<% } %>
		
		<% // One-To-Many & Many-To-Many %>
		<% foreach(TableKeySchema tks in SourceTable.PrimaryKeys) { %>
		<% foreach(MemberColumnSchema mcs in tks.ForeignKeyMemberColumns) { %>
		<% if (!mcs.IsPrimaryKeyMember) { %>
		<% if (!IsManyToMany(mcs.Table)) { %>
		<% if (!ExcludedTables.Contains(mcs.Table)) { %>
		private IList<<%= GetClassName(mcs.Table.Name) %>> <%= GetPrivateVariableNamePlural(GetClassName(mcs.Table.Name)) %> = new List<<%= GetClassName(mcs.Table.Name) %>>();
		<% } %>
		<% } else { %>
		<% TableSchema foreignTable = GetToManyTable(mcs.Table, SourceTable); %>
		<% if (!ExcludedTables.Contains(foreignTable)) { %>
		private IList<<%= GetClassName(foreignTable.Name) %>> <%= GetPrivateVariableNamePlural(GetClassName(foreignTable.Name)) %> = new List<<%= GetClassName(foreignTable.Name) %>>();
		<% } %>
		<% } %>
		<% } %>
		<% } %>
		<% } %>
		
        #endregion

        #region Constructors

        public <%= GetClassName(SourceTable.Name) %>() { }

        #endregion

        #region Methods

        public override int GetHashCode()
        {
            System.Text.StringBuilder sb = new System.Text.StringBuilder();
            
            sb.Append(this.GetType().FullName);
            <% foreach(ColumnSchema column in SourceTable.NonKeyColumns) { %>
			sb.Append(<%= GetPrivateVariableName(column.Name) %>);
			<% } %>

            return sb.ToString().GetHashCode();
        }

        #endregion

        #region Properties

		<% // Primary Keys %>
		<% if(IsMutliColumnPrimaryKey(SourceTable.PrimaryKey)) { %>
		public override string Id
		{
			get
			{
				System.Text.StringBuilder uniqueId = new System.Text.StringBuilder();
				<% for(int x=0; x<SourceTable.PrimaryKey.MemberColumns.Count; x++) { %>
				<% if(x>0) { %>
				uniqueId.Append("^");
				<% } %>
				uniqueId.Append(<%= GetPrivateVariableName(SourceTable.PrimaryKey.MemberColumns[x].Name) %>.ToString());
				<% } %>
				return uniqueId.ToString();
			}
		}
		
		<% foreach(MemberColumnSchema mcs in SourceTable.PrimaryKey.MemberColumns) { %>
		public virtual <%= SystemCSharp[mcs.SystemType.ToString()] %> <%= GetPropertyName(mcs.Name) %>
        {
            get { return <%= GetPrivateVariableName(mcs.Name) %>; }
			set
			{
				
				<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>On<%= GetPropertyName(mcs.Name) %>Changing();<% } %>
				<%= GetPrivateVariableName(mcs.Name) %> = value;
				<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>On<%= GetPropertyName(mcs.Name) %>Changed();<% } %>
			}
        }
		<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>
		partial void On<%= GetPropertyName(mcs.Name) %>Changing();
		partial void On<%= GetPropertyName(mcs.Name) %>Changed();
		<% } %>
		
		<% } %>
		<% } %>
		<% // Primitives %>
		<% foreach(ColumnSchema column in SourceTable.NonKeyColumns) { %>
		public virtual <%= SystemCSharp[column.SystemType.ToString()] %> <%= GetPropertyName(column.Name) %>
        {
            get { return <%= GetPrivateVariableName(column.Name) %>; }
			set
			{
				<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>On<%= GetPropertyName(column.Name) %>Changing();<% } %>
				<%= GetPrivateVariableName(column.Name) %> = value;
				<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>On<%= GetPropertyName(column.Name) %>Changed();<% } %>
			}
        }
		<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>
		partial void On<%= GetPropertyName(column.Name) %>Changing();
		partial void On<%= GetPropertyName(column.Name) %>Changed();
		<% } %>
		
		<% } %>
		<% // Many-To-One %>
		<% foreach(TableKeySchema tks in SourceTable.ForeignKeys) { %>
		<% foreach(MemberColumnSchema mcs in tks.ForeignKeyMemberColumns) { %>
		<% if (!mcs.IsPrimaryKeyMember) { %>
		<% if(!ExcludedTables.Contains(tks.PrimaryKeyTable) && !mcs.IsPrimaryKeyMember) { %>
		public virtual <%= GetClassName(tks.PrimaryKeyTable.Name) %> <%= GetPropertyName(GetClassName(tks.PrimaryKeyTable.Name)) %>
        {
            get { return <%= GetPrivateVariableName(GetClassName(tks.PrimaryKeyTable.Name)) %>; }
			set
			{
				<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>On<%= GetPropertyName(GetClassName(tks.PrimaryKeyTable.Name)) %>Changing();<% } %>
				<%= GetPrivateVariableName(GetClassName(tks.PrimaryKeyTable.Name)) %> = value;
				<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>On<%= GetPropertyName(GetClassName(tks.PrimaryKeyTable.Name)) %>Changed();<% } %>
			}
        }
		<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>
		partial void On<%= GetPropertyName(GetClassName(tks.PrimaryKeyTable.Name)) %>Changing();
		partial void On<%= GetPropertyName(GetClassName(tks.PrimaryKeyTable.Name)) %>Changed();
		<% } %>
		
		<% } %>
		<% } %>
		<% } %>
		<% } %>
		<% // One-To-Many & Many-To-Many %>
		<% foreach(TableKeySchema tks in SourceTable.PrimaryKeys) { %>
		<% foreach(MemberColumnSchema mcs in tks.ForeignKeyMemberColumns) { %>
		<% if (!mcs.IsPrimaryKeyMember) { %>
		<% if (!IsManyToMany(mcs.Table)) { %>
		<% if (!ExcludedTables.Contains(mcs.Table)) { %>
		public virtual IList<<%= GetClassName(mcs.Table.Name) %>> <%= GetPropertyNamePlural(GetClassName(mcs.Table.Name)) %>
        {
            get { return <%= GetPrivateVariableNamePlural(GetClassName(mcs.Table.Name)) %>; }
            set
			{
				<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>On<%= GetPropertyNamePlural(GetClassName(mcs.Table.Name)) %>Changing();<% } %>
				<%= GetPrivateVariableNamePlural(GetClassName(mcs.Table.Name)) %> = value;
				<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>On<%= GetPropertyNamePlural(GetClassName(mcs.Table.Name)) %>Changed();<% } %>
			}
        }
		<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>
		partial void On<%= GetPropertyNamePlural(GetClassName(mcs.Table.Name)) %>Changing();
		partial void On<%= GetPropertyNamePlural(GetClassName(mcs.Table.Name)) %>Changed();
		<% } %>
		
		<% } %>
		<% } else { %>
		<% TableSchema foreignTable = GetToManyTable(mcs.Table, SourceTable); %>
		<% if (!ExcludedTables.Contains(foreignTable)) { %>
		public virtual IList<<%= GetClassName(foreignTable.Name) %>> <%= GetPropertyNamePlural(GetClassName(foreignTable.Name)) %>
        {
            get { return <%= GetPrivateVariableNamePlural(GetClassName(foreignTable.Name)) %>; }
            set
			{
				<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>On<%= GetPropertyNamePlural(GetClassName(foreignTable.Name)) %>Changing();<% } %>
				<%= GetPrivateVariableNamePlural(GetClassName(foreignTable.Name)) %> = value;
				<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>On<%= GetPropertyNamePlural(GetClassName(foreignTable.Name)) %>Changed();<% } %>
			}
        }
		<% if(VsVersion.Equals(VisualStudioVersion.VS_2008)) { %>
		partial void On<%= GetPropertyNamePlural(GetClassName(foreignTable.Name)) %>Changing();
		partial void On<%= GetPropertyNamePlural(GetClassName(foreignTable.Name)) %>Changed();
		<% } %>
		
		<% } %>
		<% } %>
		<% } %>
		<% } %>
		<% } %>
        #endregion
    }
}
