<%-- 
Name: ManagerObject.cst
Author: Tom DuPont
Description: Generates a Manager Object for NHibernate.
--%>
<%@ CodeTemplate Language="C#" Inherits="CsNHibernateHelper" Src="../Helpers/CsNHibernateHelper.cs" TargetLanguage="C#" Debug="False" Description="Generates a Manager Object for NHibernate." %>
<%@ Property Name="SourceTable" Type="SchemaExplorer.TableSchema" Optional="False" Category="1a. Source Table" Description="The source table to generate from." %>
<%@ Property Name="ExcludedTables" Type="SchemaExplorer.TableSchemaCollection" Optional="True" Category="1b. Database Options" Description="A collection of tables to be excluded during generation." %>
<%@ Property Name="NHibernateVersion" Type="NHibernateVersion" Default="v1_2" Optional="False" Category="2. NHibernate" Description="The version of NHibernate to generate for." %>
<%@ Property Name="ManagerNamespace" Type="System.String" Default="NHibernate.Generated.ManagerObjects" Optional="False" Category="3. Namespaces" Description="The desired Namespace for the Manager Objects." %>
<%@ Property Name="BusinessNamespace" Type="System.String" Default="NHibernate.Generated.BusinessObjects" Optional="False" Category="3. Namespaces" Description="The desired Namespace for the Business Objects." %>
<%@ Property Name="BaseNamespace" Type="System.String" Default="NHibernate.Generated.Base" Optional="False" Category="3. Namespaces" Description="The Namespace where the Base classes (BusinessBase & ManagerBase) are located." %>
<%@ Assembly Name="SchemaExplorer" %>
<%@ Assembly Name="System.Data" %>
<%@ Assembly Name="NHibernateHelper" Path="..\..\Common\NHibernateHelper" %>
<%@ Import Namespace="SchemaExplorer" %>
<%@ Import Namespace="System.Data" %>
<%@ Import Namespace="System.Collections.Generic" %>
<%@ Import Namespace="NHibernateHelper" %>
<%@ Map Name="SystemCSharp" Src="System-CSharpAlias" %>
<% EntityManager entityManager = new EntityManager(SourceTable, ExcludedTables); %>
<% List<SearchCriteria> scList = SearchCriteria.GetAllSearchCriteria(entityManager, SourceTable); %>
using System;
using System.Collections.Generic;
using System.Text;
using NHibernate;
using <%= BusinessNamespace %>;
using <%= BaseNamespace %>;

namespace <%= ManagerNamespace %>
{
    public partial interface I<%= GetClassName(SourceTable) %>Manager : IManagerBase<<%= BusinessNamespace %>.<%= GetClassName(SourceTable) %>, <%= SystemCSharp[GetBusinessBaseIdType(SourceTable).ToString()] %>>
    {
		// Get Methods
		<% foreach(SearchCriteria sc in scList) { %>
		<% if(sc.IsPrimaryKey) { %>
		<% if(sc.Items.Count > 1) { // Override GetById%>
		<%= GetClassName(SourceTable) %> GetById(<%= GetMethodParameters(entityManager, sc.Items, true) %>);
		<% } %>
		<% } else if(!ContainsForeignKey(sc, ExcludedTables)) { %>
		<% if(sc.IsAllUnique) { %>
		<%= GetClassName(SourceTable) %> <%= GetMethodDeclaration(entityManager, sc) %>;
		<% } else { %>
		IList<<%= GetClassName(SourceTable) %>> <%= GetMethodDeclaration(entityManager, sc) %>;
		<% } } } %>
    }

    partial class <%= GetClassName(SourceTable) %>Manager : ManagerBase<<%= BusinessNamespace %>.<%= GetClassName(SourceTable) %>, <%= SystemCSharp[GetBusinessBaseIdType(SourceTable).ToString()] %>>, I<%= GetClassName(SourceTable) %>Manager
    {
		#region Constructors
		
		public <%= GetClassName(SourceTable) %>Manager() : base()
        {
        }
        public <%= GetClassName(SourceTable) %>Manager(INHibernateSession session) : base(session)
        {
        }
		
		#endregion
		
        #region Get Methods

		<% foreach(SearchCriteria sc in scList) { %>
		<% if(sc.IsPrimaryKey) { %>
		<% if(sc.Items.Count > 1) { // Override GetById%>
		public override <%= GetClassName(SourceTable) %> GetById(string id)
		{
			string[] keys = id.Split('^');
			
			if(keys.Length != <%= sc.Items.Count %>)
				throw new Exception("Invalid Id for <%= GetClassName(SourceTable) %>Manager.GetById");
			
			return GetById(<%= GetPrimaryKeyCallParameters(sc.Items) %>);
		}
		public <%= GetClassName(SourceTable) %> GetById(<%= GetMethodParameters(entityManager, sc.Items, true) %>)
		{
			ICriteria criteria = Session.GetISession().CreateCriteria(typeof(<%= GetClassName(SourceTable) %>));
			
			<% foreach(MemberColumnSchema mcs in sc.Items) { %>
			criteria.Add(<%= GetCriterionNamespace(this.NHibernateVersion) %>.Expression.Eq("<%= mcs.Name %>", <%= KeyWords[entityManager.GetEntityBaseFromColumn(mcs).VariableName] %>));
			<% } %>
			
			<%= GetClassName(SourceTable) %> result = (<%= GetClassName(SourceTable) %>)criteria.UniqueResult();

            if (result == null)
                throw new NHibernate.ObjectDeletedException("", null, null);

            return result;
		}
		
		<% } %>
		<% } else if(!ContainsForeignKey(sc, ExcludedTables)) { %>
		
		<% if(sc.IsAllUnique) { %>
		public <%= GetClassName(SourceTable) %> <%= GetMethodDeclaration(entityManager, sc) %>
		<% } else { %>
		public IList<<%= GetClassName(SourceTable) %>> <%= GetMethodDeclaration(entityManager, sc) %>
		<% } %>
        {
            ICriteria criteria = Session.GetISession().CreateCriteria(typeof(<%= GetClassName(SourceTable) %>));
			
			<% foreach(MemberColumnSchema mcs in sc.Items) { %>
			
			<% if(mcs.IsForeignKeyMember) { %>
			<% EntityAssociation association = entityManager.GetAssocitionFromColumn(mcs); %>
			<% if(association == null) { %>
			<% EntityMember em = entityManager.GetMemberFromColumn(mcs); %>
			ICriteria <%= em.VariableName %>Criteria = criteria.CreateCriteria("<%= em.PropertyName %>");
            <%= em.VariableName %>Criteria.Add(<%= GetCriterionNamespace(this.NHibernateVersion) %>.Expression.Eq("Id", <%= KeyWords[entityManager.GetEntityBaseFromColumn(mcs).VariableName] %>));
			<% } else { %>
			ICriteria <%= association.VariableName %>Criteria = criteria.CreateCriteria("<%= association.PropertyName %>");
            <%= association.VariableName %>Criteria.Add(<%= GetCriterionNamespace(this.NHibernateVersion) %>.Expression.Eq("Id", <%= KeyWords[entityManager.GetEntityBaseFromColumn(mcs).VariableName] %>));
			<% } %>
			<% } else { %>
			criteria.Add(<%= GetCriterionNamespace(this.NHibernateVersion) %>.Expression.Eq("<%= entityManager.GetEntityBaseFromColumn(mcs).PropertyName %>", <%= KeyWords[entityManager.GetEntityBaseFromColumn(mcs).VariableName] %>));
			<% } %>
			<% } %>
			
			<% if(sc.IsAllUnique) { %>
			IList<<%= GetClassName(SourceTable) %>> result = criteria.List<<%= GetClassName(SourceTable) %>>();
			return (result.Count > 0) ? result[0] : null;
			<% } else { %>
			return criteria.List<<%= GetClassName(SourceTable) %>>();
			<% } %>
        }
		<% } } %>
		
		#endregion
    }
}